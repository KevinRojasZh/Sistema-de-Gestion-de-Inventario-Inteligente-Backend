# Documentation: Inventory Management Project with AI and S3

This document details the architecture, data modeling, environment configuration, and RESTful API endpoints. The application, built on Express.js and MongoDB/Mongoose, focuses on inventory management, using Google Gemini AI for automatic product cataloging and AWS S3 for image storage.

## I. Configuration and Environment

The application uses an environment variable system to manage dynamic settings.

### Component Overview

| Component             | Description                                    | Configuration Details                            |
| --------------------- | ---------------------------------------------- | ------------------------------------------------ |
| Environment Variables | Uses dotenv/config to load variables from .env | Loaded at server start                           |
| Server Port           | Port used by Express                           | `process.env.PORT` or 3001                       |
| Database              | MongoDB connection URI                         | Uses `TEST_MONGODB_URI` if `NODE_ENV === 'test'` |
| DB Connection         | Handled by `connectToDataBase`                 | Uses `mongoose.connect(config.MONGODB_URI)`      |
| JWT Secret            | Key for signing tokens                         | Default: `SECRET = 'HOLA'`                       |

---

## II. Data Modeling (Mongoose Schemas)

Two primary schemas are used in the database: **Product** and **User**.

### A. Product Schema

Defines the structure of inventory items.

| Field          | Type     | Required | Details                   |
| -------------- | -------- | -------- | ------------------------- |
| name           | String   | Yes      | Minimum 3 characters      |
| price          | Number   | Yes      |                           |
| stock          | Number   | Yes      |                           |
| serial_number  | String   | No       |                           |
| description_ia | String   | No       | Generated by AI           |
| category_ia    | String   | No       | Generated by AI           |
| image_url      | String   | No       | Image stored in AWS S3    |
| user           | ObjectId | No       | Reference to creator user |

**Properties and Search:**

- Includes `timestamps: true`
- JSON transform removes `_id` and replaces with `id`
- Text index on: **name**, **category_ia**, **description_ia**

---

### B. User Schema

Defines system users.

| Field        | Type            | Required | Details                    |
| ------------ | --------------- | -------- | -------------------------- |
| name         | String          | Yes      |                            |
| userName     | String          | Yes      | Must be unique             |
| passwordHass | String          | Yes      | Stores bcrypt hash         |
| product      | Array<ObjectId> | No       | Reference to user products |

**Security & Transformation:**

- Password hashing with bcrypt (`saltRounds = 10`)
- `passwordHass` removed in JSON output

---

## III. Server Architecture and Middleware

The Express server uses structured middleware:

| Middleware               | Purpose                      | Technical Details                           |
| ------------------------ | ---------------------------- | ------------------------------------------- |
| `cors()`                 | Enable cross-origin requests |                                             |
| `express.static('dist')` | Serve frontend               | From `dist` folder                          |
| `express.json()`         | JSON parsing                 | Parses request bodies                       |
| `requestLogger`          | Request logging              | Logs method, route, body                    |
| `tokenExtractor`         | Extracts JWT                 | From Authorization header                   |
| `userExtract`            | Validates JWT                | Sets `request.user`, returns 401 on failure |
| `upload`                 | File handling                | Multer with `memoryStorage()`               |
| `validationSchema`       | Validates body               | Joi validation                              |
| `unknownEndpoint`        | Handles 404                  | For undefined routes                        |
| `errorHandler`           | Centralized error handling   | Handles Mongoose, Joi, and duplicate errors |

---

## IV. API Endpoints

### A. Product Management (`/api/products`)

Authentication required (JWT).

| Method | Route  | Description          | Logic Flow                                          |
| ------ | ------ | -------------------- | --------------------------------------------------- |
| POST   | `/`    | Create new product   | Upload image → Gemini → Save product → Link to user |
| GET    | `/`    | List/filter/paginate | Supports: text search, stock range, category filter |
| PATCH  | `/:id` | Update product       | Validates body, updates product                     |
| DELETE | `/:id` | Delete product       | Only creator can delete                             |

---

### B. Authentication & Users

| Method | Route               | Description   | Logic                                    |
| ------ | ------------------- | ------------- | ---------------------------------------- |
| POST   | `/api/login`        | User login    | Validates password (bcrypt), returns JWT |
| POST   | `/api/users/signup` | Register user | Hashes password, validates length        |
| GET    | `/api/users`        | List users    | Populates products                       |

---

### C. Reports

| Method | Route                         | Description            | Output                                        |
| ------ | ----------------------------- | ---------------------- | --------------------------------------------- |
| GET    | `/api/reports/inventario-csv` | Generate inventory CSV | Generates `/tmp/inventario.csv` and downloads |

---

## V. External Service Integrations

### A. Google Gemini AI

- Function: `analyzeProduct(name)`
- Model: `gemini-2.5-flash`
- Output: JSON `{ "descripcion": "...", "categoria": "..." }`
- JSON extraction uses regex to sanitize text responses

### B. AWS S3 (Image Storage)

- Function: `uploadFileToS3(fileBuffer, mimetype)`
- Requires: `AWS_REGION`, `AWS_KEY`, `AWS_SECRET`, `AWS_BUCKET`
- Generates unique filename via `crypto.randomUUID()`
- Returns public image URL

---

## VI. Testing (E2E and Unit)

Frameworks: **node:test + supertest**

### Coverage:

- Full E2E: S3 upload + Gemini AI generation
- CRUD operations
- Pagination, filtering, search
- Error cases: missing fields, negative stock, duplicate serial numbers
- DB cleanup before tests
- Login flow included

---
